---
title: "Health vs. Income"
author: "Yiyun Gong"
output: html_notebook
---

```{r}
# always clean up R environment
rm(list = ls())

# load all packages here
library(dplyr)
library(reshape2)
library(tidyr)
library(ggplot2)
# load dataset
health_allPop<-
  read.csv("Health_allPop.csv", header = T)
health_percapita<-
  read.csv("Health_percapita.csv", header = T)
income<-
  read.csv("income.csv", header = T)
income_num<-
  read.csv("income_num.csv", header = T)
# user-defined function
remove_comma<-
  function(table_name){
    ncol<-
      ncol(table_name)
    for (i in 2:ncol){
      table_name[,i]<-
        gsub(",","",table_name[,i])
      table_name[,i]<-
        as.numeric(table_name[,i])
    }
    return(table_name)
}
```

#Data Wrangling

###Data Clearing income_num dataset
```{r}
income_num$Year<-
  substr(income_num$Year, 1, 4)
```

```{r}
income_num<-
  remove_comma(income_num)
```

#subsetting and merging datasets income_num and health_percapita
```{r}
income_num$Year<-
  as.numeric(income_num$Year)
income_num_sub<-
  income_num %>%
  filter(Year>1999&Year<2016)%>%
  arrange(Year)
```

```{r}
health_percapita<-
  remove_comma(health_percapita)
health_allPop<-
  remove_comma(health_allPop)
```

#join avg income with average insurance price per capita
```{r}
insurance_income<-
  merge(x=income_num_sub, y=health_percapita, by = "Year", all=TRUE)
```

#calculate the percentage of insurance/income
```{r}
insurance_income<-
  insurance_income %>%
  mutate(ins_percentage = Health/Third.fifth)
```

#spread and gather income
```{r}
income_status<-
  income %>%
  spread(key = Subject, value = Estimate)
```

######need to work on this later
```{r}
health_allPop_gather<-
  health_allPop[,c('Year', 'Health', 'Health.services', 'Medical.products..appliances.and.equipment')]
```

```{r}
health_allPop_gather_test<-
  health_allPop_gather %>%
  gather(key = Health.services, value = Health, -Year)
```
###Ahhhhhh

#apply function
```{r}
health_percapita %>%
  select(Health, Health.services, Medical.products..appliances.and.equipment) %>%
  apply(MARGIN = 2, FUN = median, na.rm=TRUE)
```

#Data Visualization
```{r}
g <- 
  ggplot(data = health_allPop, aes(y = Health, x = Year))
g + geom_point(size = 3)
```



```{r}
g <- ggplot(data = health_allPop, aes(y = Health, x = Year))
g + geom_point(size = 3)
```

```{r}
#p <- ggplot(data = health_percapita,
#            aes(x = reorder(Health.services), y = Health)) +
#  geom_bar(fill = "grey", stat = "identity") +
#  ylab("Average Insurance Charges ($)") + xlab("Medical Procedure") +
#  theme(axis.text.x = element_text(angle = 90, hjust = 1))
#p
```

```{r}
#p + geom_point(data = MedicareCharges, size = 1, alpha = 0.3)
```

```{r}
ggplot(data = income, aes(x = Estimate, fill=Subject))+geom_density()
```

```{r}
#ggplot(data = head(health_percapita, 10), aes(x = reorder(state, math), y = math)) + 
#  geom_bar(stat = "identity")
```

```{r}
ggplot(data = insurance_income, aes(x = Year, y = ins_percentage))+
  geom_point()+
  geom_smooth(method = "lm")+
  ggtitle("insurance percentage per year")
```

```{r}
ggplot(data = head(health_percapita), aes(x = Year, y = Health)) + 
  geom_bar(stat = "identity") +
  ggtitle("Health expenses per year") +
  ylab("Health expenses") 
```

#Data Analysis

#Statistical modeling/Supervised learning
