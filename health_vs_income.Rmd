---
title: "Health vs. Income"
author: "Yiyun Gong"
output: html_notebook
---

```{r}
# always clean up R environment
rm(list = ls())

# load all packages here
library(dplyr)
library(reshape2)
library(tidyr)
library(ggplot2)
library(mosaic)
library(mdsr) 
library(Lahman)
library(readxl)
library(ape)
library(mclust)
library(lubridate)
# load dataset
health_allPop<-
  read.csv("Health_allPop.csv", header = T)
health_percapita<-
  read.csv("Health_percapita.csv", header = T)
income<-
  read.csv("income.csv", header = T)
income_num<-
  read.csv("income_num.csv", header = T)
# user-defined function
remove_comma<-
  function(table_name){
    ncol<-
      ncol(table_name)
    for (i in 2:ncol){
      table_name[,i]<-
        gsub(",","",table_name[,i])
      table_name[,i]<-
        as.numeric(table_name[,i])
    }
    return(table_name)
  }

#user-defined simulation function
hein<-
  function(a, b, c, d, e){
    health_service<-
      sample(a, 1)
    health_equipment<-
      sample(b, 1)
    medianIncome<-
      sample(c, 1)
    lowIncome<-
      sample(d, 1)
    highIncome<-
      sample(e, 1)
    health_sim<-
      health_service+health_equipment
    percent_med<-
      health_sim/medianIncome
    percent_low<-
      health_sim/lowIncome
    percent_high<-
      health_sim/highIncome
      
    return(data.frame(health_sim, health_service, health_equipment, medianIncome, percent_med, lowIncome, percent_low, highIncome, percent_high))
  }
```

#Data Wrangling

###Data Clearing income_num dataset
```{r}
income_num$Year<-
  substr(income_num$Year, 1, 4)
#repeated year data
income_num<-
  income_num[-5,]
income_num$Year<-
  as.numeric(income_num$Year)
```

```{r}
income_num<-
  remove_comma(income_num)
```

#subsetting and merging datasets income_num and health_percapita
```{r}
income_num$Year<-
  as.numeric(income_num$Year)
income_num_sub<-
  income_num %>%
  filter(Year>1999&Year<2016)%>%
  arrange(Year)
```

```{r}
health_percapita<-
  remove_comma(health_percapita)
health_allPop<-
  remove_comma(health_allPop)
```

#join avg income with average insurance price per capita
```{r}
insurance_income<-
  merge(x=income_num_sub, y=health_percapita, by = "Year", all=TRUE)
```

#calculate the percentage of insurance/income
```{r}
insurance_income<-
  insurance_income %>%
  mutate(ins_percentage = Health/Third.fifth)
```

#spread and gather income
```{r}
income_status<-
  income %>%
  spread(key = Subject, value = Estimate)
```

```{r}
income_subject<-
  income %>%
  spread(key = Status, value = Estimate)
```

######need to work on this later
```{r}
#health_allPop_gather<-
#  health_allPop[,c('Year', 'Health', 'Health.services', #'Medical.products..appliances.and.equipment')]
```

```{r}
#health_allPop_gather_test<-
#  health_allPop_gather %>%
#  gather(key = Health.services, value = Health, -Year)
```
###Ahhhhhh

#apply function
```{r}
health_percapita %>%
  select(Health, Health.services, Medical.products..appliances.and.equipment) %>%
  apply(MARGIN = 2, FUN = median, na.rm=TRUE)
```

#Data Visualization
```{r fig.width=5, fig.asp=0.4}
#US Income distribution
ggplot(data = income_num, aes(x = Year, y=Third.fifth, colour="Median Income"))+
  geom_line()+
  geom_line(data = income_num, aes(x=Year, y=Lowest.fifth, colour="Lowest fifth mean income"))+
  geom_line(data = income_num, aes(x=Year, y=Highest.fifth, colour="Highest fifth mean income"))+
  geom_line(data = income_num, aes(x=Year, y=Top.5.percent, colour="Top 5% mean income"))+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5))+
  xlab("Year")+
  ylab("Income")+
  scale_x_continuous(breaks = income_num$Year)
```

```{r fig.width=5, fig.asp=0.7, message=FALSE}
#need to change the labels and titles
ggplot(data = health_percapita, aes(x = Year, y = Health)) + 
  geom_bar(stat = "identity") +
  geom_point(data = income_num_sub, aes(x=Year, y=Third.fifth))+
  geom_smooth(data = income_num_sub, aes(x=Year, y=Third.fifth), show.legend = FALSE, method = "auto")+
  ggtitle("Health expenses and median income 2000-2015") +
  ylab("Health expenses and Income")+
  scale_x_continuous(breaks = insurance_income$Year)
```

```{r}
ggplot(data = insurance_income, aes(x = Year, y = ins_percentage))+
  geom_point()+
  geom_smooth(method = "lm")+
  ggtitle("insurance percentage per year")
```

```{r}
ggplot(data = insurance_income,
            aes(x = Third.fifth, y = Health.services)) +
  geom_bar(fill = "grey", stat = "identity") +
  ylab("Average Insurance Charges ($)") + xlab("Average Income") +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```


```{r}
ggplot(data = income, aes(x = Estimate, fill=Subject))+
  geom_density()+
  xlab("Percentage in Each Subject")
```



#Data Analysis

#Statistical modeling/Supervised learning

#Unsupervised learning

##Hierarchical clustering
```{r}
unsuperSet<-
  insurance_income
rownames(unsuperSet)<-
  c(2000:2015)
```

```{r}
set_diffs<-
  dist(unsuperSet)
str(set_diffs)
```

```{r}
set_mat<-
  set_diffs %>% 
  as.matrix() %>%
  round(digits = 2)
#glimpse on the matrix
set_mat[1:6, 1:6]
```

```{r}
set_diffs %>%
  hclust() %>%
  as.phylo() %>%
  plot(cex=0.9, label.offset = 1)
```
A dendrogram constructed by hierarchical clustering from year-to-year distance data.

##K-means
```{r}
supSet<-
  insurance_income
set.seed(2500)
set_clusts_ii<- 
  supSet %>% 
  kmeans(centers = 8)
str(set_clusts_ii)
```


```{r fig.width=5, fig.asp=0.7}
set.seed(2500)
set_clusts_ii<- 
  supSet %>% 
  kmeans(centers = 8) %>%
  fitted("classes") %>% 
  as.character()
supSet <- 
  supSet %>% mutate(cluster = set_clusts_ii)
supSet %>% 
  ggplot(aes(x = Year, y = ins_percentage)) +
  geom_point(aes(color = cluster), alpha = 0.5)+
  scale_x_continuous(breaks = income_num$Year)
```

```{r}
supSet<-
  income[,c('Year', 'Estimate')]
set.seed(1200)
set_clusts <- 
  supSet %>% 
  kmeans(centers = 8)
str(set_clusts)
```

```{r}
set.seed(1200)
set_clusts <- 
  supSet %>% 
  kmeans(centers = 8) %>%
  fitted("classes") %>% 
  as.character()
supSet <- 
  supSet %>% mutate(cluster = set_clusts)
supSet %>% 
  ggplot(aes(x = Year, y = Estimate)) +
  geom_point(aes(color = cluster), alpha = 0.5)+
  scale_x_continuous(breaks = income$Year)
```

#User-defined simulation(Bootstrapping)
```{r}
set.seed(800)
healthserv_set<-
  insurance_income$Health.services
equip_set<-
  insurance_income$Medical.products..appliances.and.equipment
income_set<-
  insurance_income$Third.fifth
income_top<-
  insurance_income$Highest.fifth
income_low<-
  insurance_income$Lowest.fifth
percent_sim<-
  do(5000)*hein(healthserv_set, equip_set, income_set, income_low, income_top)
```

```{r}
head(percent_sim)
```

```{r}
summary(percent_sim$health_sim)
summary(percent_sim$health_service)
summary(percent_sim$health_equipment)
```

```{r fig.width=5, fig.asp=0.7}
ggplot(data=percent_sim, aes(x=health_sim, color="Health Expend"))+
  geom_density()+
  geom_density(data=percent_sim, aes(x=medianIncome, color="medianIncome"))+
  geom_density(data=percent_sim, aes(x=highIncome, color="highIncome"))+
  geom_density(data=percent_sim, aes(x=lowIncome, color="lowIncome"))+
  scale_x_continuous("Expentuire on insurance and income levels")
```
```{r}
#ACA affordability percentage
afford<-
  mean(c(0.0956, 0.0966, 0.0969, 0.0956, 0.0986))
afford
```


```{r fig.width=3, fig.asp=0.6}
ggplot(data=percent_sim, aes(x=percent_med, color="median income"))+
  geom_density()+
  geom_density(data=percent_sim, aes(x=percent_low, color="Lowest fifth"))+
  geom_density(data=percent_sim, aes(x=percent_high, color="Highest fifth"))+
  geom_vline(xintercept = afford, linetype = 2, color="Brown")+
  scale_x_continuous("percent of health expentuire on income", breaks = (0:10)/10)
```





